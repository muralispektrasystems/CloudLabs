# Exercise 2: Installing a Web Server and connecting to the RDS Database instance

In this exercise, you will install a Web server on the EC2 instance named **Web Server** you created earlier.The web server connects to the Amazon RDS DB instance that you created previously. After installing and configuring the web server successfully, you will be able to run it using the public IP/ DNS name of the Web server instance and will create entries which will directly be created in the RDS MySQL database you've created.

## Task 1: Install the Apache web server with PHP and MariaDB

In this task, you will connect to your EC2 instance and install the **Apache web server** with **PHP** and **MariaDB**. To access and install the requisites in your EC2 instance, follow the given steps:

1. Open **PowerShell** in your system and go in the directory where your EC2 instance key pair, named **Web_Server_Key** or **demo-kp** (as per what you provided) is downloaded using **cd (directory path)** command.

    ![](./media/ps-cd.png)

    **For Mac Users:** Open **Terminal** in your system and go in the directory where your EC2 instance key pair, named **Web_Server_Key** or **demo-kp** (as per what you provided) is downloaded using **cd (directory path)** command.

    ![](./media/tl-cd.png)

1. Provide the following command to SSH into your web server instance and hit Enter.

    `ssh -i .\Web_Server_Key.pem ec2-user@ec2-instance-public-ip`

    Confirm the action by entering **yes**. You will be connected to your web server EC2 instance.

    ![](./media/ps-connected.png)

    **For Mac Users:** As a pre-requisite before using the ssh command, you need to modify the permissions on the key pair file so as to utilize it for connecting it to your web server instance. To modify the permission of the file, us the following command:

    `
    chmod 400 [your-key-pair-name]
    `

    ![](./media/tl-connected.png)

1. Get the latest bug fixes and security updates by updating the software on your EC2 instance. To do this, use the following command:

    `sudo dnf update -y`

1. After the updates complete, install the **Apache web server**, **PHP**, and **MariaDB** software using the following command:

    `sudo dnf install -y httpd php php-mysqli mariadb105`

    This command installs multiple software packages and related dependencies at the same time.

1. After the installation completes, start the web server using the following command:

    `sudo systemctl start httpd`

1. You can test that your web server is properly installed and started by providing the public ip address of your web server instance beginning with **http://**. An Apache test page will appear to confirm that your web server is running properly.

    ![](./media/apache-test.png)

1. Configure the web server to start with each system boot using the following **systemctl** command:

    `sudo systemctl enable httpd`

### Task 1.1: Setting file permissions for the Apache web server

To allow you as an **ec2-user** to manage files in the default root directory for your Apache web server, you will modify the ownership and permissions of the **/var/www** directory. To do so, you will add **ec2-user** to the **apache** group, give the **apache** group ownership of the **/var/www** directory and assign write permissions to the group. To set the file permisions, follow the given steps:

1. Add the ec2-user user to the apache group by providing the following command:

    `sudo usermod -a -G apache ec2-user`

1. Enter `exit` to logout and log back in using ssh command again to refresh your permissions.

1. Once you log in again, verify that the apache group exists using the `groups` command.

    You will get an output similar to the following, where **apache** group will be included in the groups list:

    `ec2-user adm wheel apache systemd-journal`

1. Now, change the group ownership of the **/var/www** directory and its contents to the **apache** group with the following command:

    `sudo chown -R ec2-user:apache /var/www`

1. Now, change the directory permissions of **/var/www** and its subdirectories to add group write permissions and set the group ID on subdirectories created in the future using the following command:

    ```
    sudo chmod 2775 /var/www
    find /var/www -type d -exec sudo chmod 2775 {} \;
    ```

1. Recursively change the permissions for files in the /var/www directory and its subdirectories to add group write permissions.

    ```
    find /var/www -type f -exec sudo chmod 0664 {} \;
    ```

Now, **ec2-user** (and any future members of the **apache** group) can add, delete, and edit files in the Apache document root. This makes it possible for you to add content, such as a static website or a PHP application.

## Task 2: Configure the Apache web server to connect to the RDS database instance

In this task, you will add content to your Apache web server to display a page for basic **Employee details** properties, and connect the backend to the **RDS Database** which you created in the last exercise by follwing the given steps:

1. While still connected to your EC2 instance, change the directory to **/var/www** and create a new subdirectory named **inc** using the following commands:

    ```
    cd /var/www
    mkdir inc
    cd inc
    ```

1. Now, create a new file in the **inc** directory named **dbinfo.inc**, and then edit the file by calling **nano** using the following commands:

    ```
    >dbinfo.inc
    nano dbinfo.inc
    ```

1. The nano editor will open the **dbinfo.inc** file. Add the following content into the file and replace the **db_instance_endpoint** to the ednpoint of your Database instance which you noted in the last exercise and **master password** to the password you set while creating the database, i.e. **admin123**.

    ```
    <?php

    define('DB_SERVER', 'db_instance_endpoint');
    define('DB_USERNAME', 'tutorial_user');
    define('DB_PASSWORD', 'master password');
    define('DB_DATABASE', 'sample');
    ?>
    ```

1. Save and close the **dbinfo.inc** file by using **Ctrl+S** and **Ctrl+X**.

1. Change the directory to /var/www/html using `cd /var/www/html`.

1. Create a new file in the **html** directory named **SamplePage.php**, and then edit the file by calling nano (or the editor of your choice).

    ```
    >SamplePage.php
    nano SamplePage.php
    ```

1. The nano editor will open the **SamplePage.php** file. Add the following content into it:

    <div style="margin-left:10px">
        ```
    <?php include "../inc/dbinfo.inc"; ?>
    <html>
    <body>
    <h1>Sample page</h1>
    <?php

        /* Connect to MySQL and select the database. */
        $connection = mysqli_connect(DB_SERVER, DB_USERNAME, DB_PASSWORD);

        if (mysqli_connect_errno()) echo "Failed to connect to MySQL: " . mysqli_connect_error();

        $database = mysqli_select_db($connection, DB_DATABASE);

        /* Ensure that the EMPLOYEES table exists. */
        VerifyEmployeesTable($connection, DB_DATABASE);

        /* If input fields are populated, add a row to the EMPLOYEES table. */
        $employee_name = htmlentities($_POST['NAME']);
        $employee_address = htmlentities($_POST['ADDRESS']);

        if (strlen($employee_name) || strlen($employee_address)) {
            AddEmployee($connection, $employee_name, $employee_address);
        }
    ?>

    <!-- Input form -->
    <form action="<?PHP echo $_SERVER['SCRIPT_NAME'] ?>" method="POST">
        <table border="0">
            <tr>
                <td>NAME</td>
                <td>ADDRESS</td>
            </tr>
            <tr>
                <td>
                    <input type="text" name="NAME" maxlength="45" size="30" />
                </td>
                <td>
                    <input type="text" name="ADDRESS" maxlength="90" size="60" />
                </td>
                <td>
                    <input type="submit" value="Add Data" />
                </td>
            </tr>
        </table>
    </form>

    <!-- Display table data. -->
    <table border="1" cellpadding="2" cellspacing="2">
        <tr>
            <td>ID</td>
            <td>NAME</td>
            <td>ADDRESS</td>
        </tr>

    <?php

    $result = mysqli_query($connection, "SELECT * FROM EMPLOYEES");

    while($query_data = mysqli_fetch_row($result)) {
        echo "<tr>";
        echo "<td>",$query_data[0], "</td>",
             "<td>",$query_data[1], "</td>",
             "<td>",$query_data[2], "</td>";
        echo "</tr>";
    }
    ?>

    </table>

    <!-- Clean up. -->
    <?php

        mysqli_free_result($result);
        mysqli_close($connection);

    ?>

    </body>
    </html>


    <?php

    /* Add an employee to the table. */
    function AddEmployee($connection, $name, $address) {
        $n = mysqli_real_escape_string($connection, $name);
        $a = mysqli_real_escape_string($connection, $address);

        $query = "INSERT INTO EMPLOYEES (NAME, ADDRESS) VALUES ('$n', '$a');";

        if(!mysqli_query($connection, $query)) echo("<p>Error adding employee data.</p>");
    }

    /* Check whether the table exists and, if not, create it. */
    function VerifyEmployeesTable($connection, $dbName) {
        if(!TableExists("EMPLOYEES", $connection, $dbName))
        {
            $query = "CREATE TABLE EMPLOYEES (
                ID int(11) UNSIGNED AUTO_INCREMENT PRIMARY KEY,
                NAME VARCHAR(45),
                ADDRESS VARCHAR(90)
                )";

            if(!mysqli_query($connection, $query)) echo("<p>Error creating table.</p>");
        }
    }

    /* Check for the existence of a table. */
    function TableExists($tableName, $connection, $dbName) {
        $t = mysqli_real_escape_string($connection, $tableName);
        $d = mysqli_real_escape_string($connection, $dbName);

        $checktable = mysqli_query($connection,
            "SELECT TABLE_NAME FROM information_schema.TABLES WHERE TABLE_NAME = '$t' AND TABLE_SCHEMA = '$d'");

        if(mysqli_num_rows($checktable) > 0) return true;

        return false;
    }
    ?>
       ```
   </div>            


    - The **PHP** file tries to establish a connection to the MySQL server using the provided database connection info and verifies if the **EMPLOYEES** table exists in the database. If it doesn't exist, it creates one. The script checks if the **NAME** and **ADDRESS** fields are populated in the POST request. If they are, it escapes any1. It starts by including a file named dbinfo.inc. This file presumably contains information for connecting to a MySQL database, such as the **server name**, **username**, **password**, and **database name**.
  
    - After the form, it fetches all rows from the **EMPLOYEES** table and displays them in an HTML table. It then frees the result set from the previous MySQL query and closes the database connection.
  
    - The script then checks if the '**NAME**' and '**ADDRESS**' fields in the HTTP POST request are populated (i.e., if the form has beenEmployee, VerifyEmployeesTable, and TableExists` and performs the related action like **AddEmployee** adds a new employee to the **EMPLOYEES** table and **VerifyEmployeesTable** checks if the `EMP submitted), and if they are, it adds a new row to the '**EMPLOYEES**' table using the **AddEmployee()** function.
  
    - **TableExists** checks if a table exists in the database.
    
1. Save and close the **SamplePage.php** file by using **Ctrl+S** and **Ctrl+X**.

1. Access you EC2 instance (web server) through a browser by providing the URL in the following format:

    `http://<public ip of EC2 instance>/SamplePage.php`

    A page like this will appear:

    ![](./media/sample-page.png)

## Task 3: Create entries into the table in the database through Web server

After you have created **SamplePage.php** in the **Apache web serevr**, it can be used to add data to your DB instance. The data that you add is then displayed on the page. To verify that the data was inserted into the table, MySQL client can be used on the Amazon EC2 instance to connect to the DB. In this task, you will create enteries in the web server page and add data in the MySQL database instance by following the given steps:

1. Visit the Sample web page to add the details in your database through the URL you set up earlier. The sample page will appear as given, which will create entries namely, ID, Name and Address into the RDS database.

    ![](./media/sample-page-values.png)

1. Now, provide a name like `John Doe`, in the **Name** field and an address like `Jadewood Farms, New Brunswick, New Jersey` in the **Address** field and select **Add Data** to save the particular relational data in the RDS database directly.

    ![](./media/sample-page-entry1.png)

1. Similarly add 2 more entries in the database with the name and address of your own wish and see the provided output.

    ![](./media/sample-page-entries2.png)

    The entries you've created on the webpage have also been added to the RDS database.

**In this exercise, you have learnt how to install the Apache web server with PHP and MariaDB, and successfully configured it to connect to your RDS MySQL database instance as well as have created a few entries in the database through your web server.**
